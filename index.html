<!doctype html><html lang="en"><head><meta charset="utf-8"><title>&#x1F433; 24 random docker tips</title><meta name="viewport" content="width=device-width,initial-scale=1"></head><body><style>.markdown-body{-ms-text-size-adjust:100%;-webkit-text-size-adjust:100%;color:#24292e;font-family:-apple-system,BlinkMacSystemFont,Segoe UI,Helvetica,Arial,sans-serif;font-size:16px;line-height:1.5;word-wrap:break-word}.markdown-body a{background-color:transparent}.markdown-body a:active,.markdown-body a:hover{outline-width:0}.markdown-body h1{margin:.67em 0}.markdown-body img{border-style:none}.markdown-body code,.markdown-body pre{font-family:monospace,monospace;font-size:1em}.markdown-body *{box-sizing:border-box}.markdown-body a{color:#0366d6;text-decoration:none}.markdown-body a:hover{text-decoration:underline}.markdown-body h1,.markdown-body h2,.markdown-body h3{margin-top:0;margin-bottom:0}.markdown-body h1{font-size:32px;font-weight:600}.markdown-body h2{font-size:24px;font-weight:600}.markdown-body h3{font-size:20px;font-weight:600}.markdown-body p{margin-top:0;margin-bottom:10px}.markdown-body code,.markdown-body pre{font-family:SFMono-Regular,Consolas,Liberation Mono,Menlo,Courier,monospace;font-size:12px}.markdown-body pre{margin-top:0;margin-bottom:0}.markdown-body:after,.markdown-body:before{display:table;content:""}.markdown-body:after{clear:both}.markdown-body>:first-child{margin-top:0!important}.markdown-body>:last-child{margin-bottom:0!important}.markdown-body p,.markdown-body pre{margin-top:0;margin-bottom:16px}.markdown-body h1,.markdown-body h2,.markdown-body h3{margin-top:24px;margin-bottom:16px;font-weight:600;line-height:1.25}.markdown-body h1{font-size:2em}.markdown-body h1,.markdown-body h2{padding-bottom:.3em;border-bottom:1px solid #eaecef}.markdown-body h2{font-size:1.5em}.markdown-body h3{font-size:1.25em}.markdown-body img{max-width:100%;box-sizing:content-box;background-color:#fff}.markdown-body code{padding:.2em .4em;margin:0;font-size:85%;background-color:rgba(27,31,35,.05);border-radius:3px}.markdown-body pre{word-wrap:normal}.markdown-body pre{padding:16px;overflow:auto;font-size:85%;line-height:1.45;background-color:#f6f8fa;border-radius:3px}.markdown-body .full-commit .btn-outline:not(:disabled):hover{color:#005cc5;border-color:#005cc5}.hljs{display:block;overflow-x:auto;padding:.5em;color:#333;background:#f8f8f8}.hljs-comment{color:#998;font-style:italic}.hljs-keyword{color:#333;font-weight:700}.hljs-template-variable{color:teal}.hljs-string{color:#d14}.hljs-name,.hljs-tag{color:navy;font-weight:400}.markdown-body{box-sizing:border-box;min-width:200px;max-width:980px;margin:0 auto;padding:45px}@media screen and (max-width:480px){.markdown-body{padding:15px}}.markdown-body .heading-anchor{color:inherit}</style><article class="markdown-body"><h1>&#x1F433; 24 random docker tips</h1><p><a href="https://csabapalfi.github.io">Csaba Palfi</a>, Dec 2014</p><p>We love docker and had it in production since 0.8 at <a href="http://www.tesglobal.com/">TES Global</a> (my current client). Couple of us could attend the trainings at dockerConEU thanks to <a href="http://contino.co.uk/">Contino</a>. Here are some of the tips and tricks that will hopefully be useful for anyone who is already familiar with docker basics.</p><h2><a class="heading-anchor" name="1-cli" href="#1-cli">1. CLI</a></h2><h3><a class="heading-anchor" name="1-1-nice-docker-ps-output" href="#1-1-nice-docker-ps-output">1.1. nice docker ps output</a></h3><p>Just pipe docker ps output to less -S so that the table rows are not wrapped:</p><pre class="hljs">docker ps -a | less -S
</pre><h3><a class="heading-anchor" name="1-2-follow-the-logs" href="#1-2-follow-the-logs">1.2 follow the logs</a></h3><p>docker logs won&apos;t watch the logs by default unless use the -f flag:</p><pre class="hljs">docker logs &lt;containerid&gt; -f
</pre><h3><a class="heading-anchor" name="1-3-a-single-value-from-docker-inspect" href="#1-3-a-single-value-from-docker-inspect">1.3 a single value from docker inspect</a></h3><p>docker inspect spits out a lots of JSON by default. You can just use jq to extract a single key. Or you can use the builtin go templating in docker inspect like below:</p><pre class="hljs"><span class="hljs-comment"># is the last run container still running?</span>
docker inspect --format <span class="hljs-string">&apos;{{.State.Running}}&apos;</span> $(docker ps -lq)
</pre><h3><a class="heading-anchor" name="1-4-code-docker-exec-code-instead-of-sshd-or-nsenter" href="#1-4-code-docker-exec-code-instead-of-sshd-or-nsenter">1.4 <code>docker exec</code> instead of sshd or nsenter</a></h3><p>This one is pretty well-known if you follow the docker releases. <code>exec</code> was introduced in 1.3 and allow you to run a new process within a container. There&apos;s no need for running sshd in the container or installing nsenter on the host anymore.</p><h2><a class="heading-anchor" name="2-dockerfiles" href="#2-dockerfiles">2. Dockerfiles</a></h2><h3><a class="heading-anchor" name="2-1-docker-build-supports-git-repos" href="#2-1-docker-build-supports-git-repos">2.1 docker build supports git repos</a></h3><p>You can not only build images from local Dockerfiles but can simply give docker build a git repo URL and it takes care of the rest.</p><h3><a class="heading-anchor" name="2-2-no-package-lists" href="#2-2-no-package-lists">2.2. no package lists</a></h3><p>Default images (e.g. ubuntu) don&apos;t include package lists to keep them smaller hence the <code>apt-get update</code> in pretty much any base Dockerfile.</p><h3><a class="heading-anchor" name="2-3-watch-out-for-package-versions" href="#2-3-watch-out-for-package-versions">2.3 watch out for package versions</a></h3><p>Be careful with package installations as those commands are cached as well. Meaning you may get different version when busting the cache or lagging behind on security updates when caching these for too long.</p><h3><a class="heading-anchor" name="2-4-small-base-images" href="#2-4-small-base-images">2.4 small base images</a></h3><p>There&apos;s an official, truly empty docker image on docker hub. It&apos;s called <a href="https://registry.hub.docker.com/_/scratch/">scratch</a>. If you want you can start your images <code>FROM scratch</code>. Most of time you&apos;re better off starting from <a href="https://registry.hub.docker.com/_/alpine/">alpine</a> if you want a really small base image (few MBs) as it has a shell and nice package manager, too.</p><h3><a class="heading-anchor" name="2-5-from-is-latest-by-default" href="#2-5-from-is-latest-by-default">2.5 FROM is latest by default</a></h3><p>If you don&apos;t specify a version in your tag then the FROM keyword will just use latest. Be careful with that and make sure you specify a version if you can.</p><h3><a class="heading-anchor" name="2-6-shell-or-exec-mode" href="#2-6-shell-or-exec-mode">2.6. shell or exec mode</a></h3><p>There are a few places where you can specify commands in your Dockerfile. (e.g. <code>CMD</code>, <code>RUN</code>). docker supports two ways of doing that. If you just write the command then docker will wrap it in <code>sh -c</code>. You can also write them as an array of strings (e.g <code>[ &quot;ls&quot;, &quot;-a&quot;]</code>). The array notation won&apos;t need a shell to be available within the container (as it uses go&apos;s exec) and that&apos;s the preferred syntax according to the docker guys.</p><h3><a class="heading-anchor" name="2-7-add-vs-copy" href="#2-7-add-vs-copy">2.7. ADD vs COPY</a></h3><p>Both <code>ADD</code> and <code>COPY</code> adds local files when building a container but ADD does some additional magic like adding remote files and ungzipping and untaring archives. Only use <code>ADD</code> if you understand this difference.</p><h3><a class="heading-anchor" name="2-8-workdir-and-env" href="#2-8-workdir-and-env">2.8 WORKDIR and ENV</a></h3><p>Each command will create a new temporary image and runs in a new shell hence if you do a <code>cd directory</code> or <code>export var=value</code> in your Dockerfile it won&apos;t work. Use <code>WORKDIR</code> to set your working directory across multiple commands and ENV to set environment variables.</p><h3><a class="heading-anchor" name="2-9-cmd-and-entrypoint" href="#2-9-cmd-and-entrypoint">2.9 CMD and ENTRYPOINT</a></h3><p><code>CMD</code> is the default command to execute when an image is run. The default <code>ENTRYPOINT</code> is <code>/bin/sh -c</code> and <code>CMD</code> is passed into that as an argument. We can override ENTRYPOINT in our Dockerfile and make our container behave like an executable taking command line arguments (with default arguments in CMD in our Dockerfile).</p><pre class="hljs"><span class="hljs-comment"># in Dockerfile</span>
<span class="hljs-keyword">ENTRYPOINT</span><span class="bash"> /bin/ls</span>
<span class="hljs-keyword">CMD</span><span class="bash"> [<span class="hljs-string">&quot;-a&quot;</span>]</span>

<span class="hljs-comment"># we&apos;re overriding the command but entrypoint remains ls</span>
docker <span class="hljs-keyword">run</span><span class="bash"> training/ls -l</span>
</pre><h3><a class="heading-anchor" name="2-10-code-add-code-your-code-last" href="#2-10-code-add-code-your-code-last">2.10 <code>ADD</code> your code last</a></h3><p>ADD invalidates your cache if files have changed. Don&apos;t invalidate the cache by adding frequently changing stuff too high up in your Dockerfile. Add your code last, libraries and dependencies first. For node.js apps that means adding your package.json first, running npm install and only then adding your code.</p><h2><a class="heading-anchor" name="3-docker-networking" href="#3-docker-networking">3. docker networking</a></h2><p>Docker has an internal pool of IPs which it uses for container IP addresses. These are invisible to the outside by default and accessible via a bridge interface.</p><h3><a class="heading-anchor" name="3-1-looking-up-port-mappings" href="#3-1-looking-up-port-mappings">3.1 looking up port mappings</a></h3><p><code>docker run</code> accepts explicit port mappings as parameters or you can specify <code>-P</code> to map all ports automatically. The latter has the advantage of preventing conflicts and looking up the assigned ports can be done as follows:</p><pre class="hljs">docker port &lt;containerId&gt; &lt;portNumber&gt;
<span class="hljs-comment"># or</span>
docker inspect --format <span class="hljs-string">&apos;{{.NetworkSettings.Ports}}&apos;</span> &lt;containerId&gt;
</pre><h3><a class="heading-anchor" name="3-2-container-ips" href="#3-2-container-ips">3.2 container IPs</a></h3><p>Each container has it&apos;s IP in a private subnet (which is 172.17.0.0/16 by default). The IP can change with restart but can be looked up should you need it:</p><pre class="hljs"><span class="xml">docker inspect --format &apos;</span><span class="hljs-template-variable">{{.NetworkSettings.IPAddress}}</span><span class="xml">&apos; <span class="hljs-tag">&lt;<span class="hljs-name">containerId</span>&gt;</span>
</span></pre><p>docker tries to detect conflicts and will use a different subnet if needed.</p><h3><a class="heading-anchor" name="3-3-taking-over-the-hosts-network-stack" href="#3-3-taking-over-the-hosts-network-stack">3.3 taking over the hosts network stack</a></h3><p><code>docker run --net=host</code> allows reusing the network stack of the host. Don&apos;t do this.</p><h2><a class="heading-anchor" name="4-volumes" href="#4-volumes">4. volumes</a></h2><p>A way to bypass copy-on-write filesystem for a directory or a single file with close to zero overhead (bind mounting).</p><h3><a class="heading-anchor" name="4-1-volume-contents-are-not-saved-on-docker-commit" href="#4-1-volume-contents-are-not-saved-on-docker-commit">4.1 volume contents are not saved on docker commit</a></h3><p>There&apos;s not much point in writing to your volumes when the image is built.</p><h3><a class="heading-anchor" name="4-2-volumes-are-read-write-by-default" href="#4-2-volumes-are-read-write-by-default">4.2 volumes are read-write by default</a></h3><p>but there&apos;s an :ro flag</p><h3><a class="heading-anchor" name="4-3-volumes-exists-separately-from-containers" href="#4-3-volumes-exists-separately-from-containers">4.3 volumes exists separately from containers</a></h3><p>And available until at least container references them. Can be shared between container with <code>--volumes-from</code>.</p><h3><a class="heading-anchor" name="4-4-mount-your-docker-sock" href="#4-4-mount-your-docker-sock">4.4 mount your docker.sock</a></h3><p>You can just mount your docker.sock to provide a container access to the docker API. You can then just run docker commands from within that container. This way a container can even kill itself. There&apos;s no need to run the docker daemon within a container.</p><h2><a class="heading-anchor" name="5-security" href="#5-security">5. security</a></h2><h3><a class="heading-anchor" name="5-1-docker-runs-as-root-" href="#5-1-docker-runs-as-root-">5.1. docker runs as root...</a></h3><p>...treat it accordingly. Docker API access gives full root access as you can map <code>/</code> as a volume, read, write. Or you can just take over the host&apos;s network with <code>--net host</code>. Don&apos;t expose docker API to public or use TLS if you do.</p><h3><a class="heading-anchor" name="5-2-user-in-dockerfiles" href="#5-2-user-in-dockerfiles">5.2 USER in Dockerfiles</a></h3><p>By default docker runs everything as root but you can use USER in Dockerfiles. There&apos;s no user namespacing in docker so the container sees the users on the host but only uids hence you need the add the users in the container.</p><h3><a class="heading-anchor" name="5-3-use-tls-on-the-docker-api" href="#5-3-use-tls-on-the-docker-api">5.3 use TLS on the docker API</a></h3><p>There was no access control on the docker API until 1.3 when they added TLS. They use mutual authentication: the client and server both has a key. Treat keys as root passwords.</p><p>Boot2docker has TLS as default since 1.3 and also generates the keys for you.</p><p>Otherwise generating keys requires OpenSSL 1.0.1 then the docker daemon needs to be run with --tls-verify and will use the secure docker port (2376).</p><p>We&apos;re hopefully getting more granular access control soon instead of all or nothing.</p><p><img src="https://ga-beacon.appspot.com/UA-29212656-1/random-docker-tips?pixel" alt></p></article></body></html>